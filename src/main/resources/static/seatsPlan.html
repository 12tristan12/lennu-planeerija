<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vali istekohad</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body data-page="seats-plan">
    <div class="container">
        <h1>Vali istekohad</h1>
        <div class="actions-bar">
            <button id="back-button" onclick="window.location.href='/'">← Tagasi</button>
            <span id="selected-class-display"></span>
        </div>
        <div id="seats-grid" class="seats-grid"></div>
        <div id="selected-seats-container" class="selected-seats-container">
            <h3>Valitud istmed:</h3>
            <ul id="selectedSeats"></ul>
            <button id="confirm-seats" disabled>Kinnita valik</button>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    
    <!-- Asendame modaali avamise lihtsa istmete laadimisega -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Võta flightId ja muud parameetrid URL-ist
            const urlParams = new URLSearchParams(window.location.search);
            const flightId = urlParams.get('flightId');
            
            // Saame soovitatud istmeklassi sessiooni salvestusest või URL-ist
            let seatClass = sessionStorage.getItem('selectedSeatClass');
            if (!seatClass) {
                seatClass = (urlParams.get('seatClass') || 'ECONOMY').toUpperCase();
            }
            
            // Kuvame valitud klassi
            const selectedClassDisplay = document.getElementById('selected-class-display');
            if (selectedClassDisplay) {
                const classNames = {
                    'ECONOMY': 'Economy',
                    'BUSINESS': 'Business',
                    'FIRST': 'First Class'
                };
                selectedClassDisplay.textContent = `Valitud klass: ${classNames[seatClass] || 'Economy'}`;
            }
            
            // Laadime istmed ilma modaalita
            async function loadSeatsDirectly() {
                try {
                    const passengers = parseInt(urlParams.get('passengers')) || 1;
                    
                    // Võta istmed otse API-st
                    const seats = await api.getSeats(flightId);
                    console.log(`Laaditud ${seats.length} istet`);
                    
                    // Importige eelistuste funktsiooni ja kasutaja eelistused URL-ist või sessionStorage-ist
                    const windowSeatPref = sessionStorage.getItem('windowSeat') === 'true';
                    const extraLegroomPref = sessionStorage.getItem('extraLegroom') === 'true';
                    
                    console.log("Laaditud eelistused:", {
                        windowSeat: windowSeatPref,
                        extraLegroom: extraLegroomPref
                    });
                    
                    // Saame soovitused koos istmeklassiga JA kasutaja eelistustega
                    const recommendedSeats = await api.getRecommendedSeats(flightId, {
                        passengers: passengers,
                        windowSeat: windowSeatPref,  // Kasutame salvestatud eelistust, mitte kõvakooditud false
                        extraLegroom: extraLegroomPref, // Kasutame salvestatud eelistust, mitte kõvakooditud false
                        seatClass: seatClass,
                        excludedSeats: []
                    });
                    console.log(`Leitud ${recommendedSeats.length} soovitatud istet`);

                    // Kuvame istmed
                    const seatsGrid = document.getElementById('seats-grid');
                    if (seatsGrid) {
                        // Kasutame olemasolevat renderSeats funktsiooni
                        const recommendedSeatNumbers = recommendedSeats.map(seat => seat.seatNumber);
                        if (typeof renderSeats === 'function') {
                            renderSeats(seats, recommendedSeatNumbers);
                        } else if (window.renderSeats) {
                            window.renderSeats(seats, recommendedSeatNumbers);
                        } else {
                            console.error('renderSeats funktsioon puudub');
                        }
                    }
                } catch (error) {
                    console.error('Viga istmete laadimisel:', error);
                }
            }
            
            loadSeatsDirectly();
        });
    </script>
</body>
</html>